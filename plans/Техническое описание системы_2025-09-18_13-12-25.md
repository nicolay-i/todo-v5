# Техническое описание проекта: Управление задачами с вложенной структурой

## 1. Обзор архитектуры

Проект представляет собой клиент-серверное приложение для управления задачами с поддержкой вложенной структуры и закрепления задач в специальных слотах. Основные архитектурные решения:

- **Фреймворк**: Next.js с использованием App Router
- **Управление состоянием**: MobX для клиентского состояния
- **База данных**: PostgreSQL с ORM Prisma
- **Стили**: Tailwind CSS
- **Архитектурный паттерн**: MVC с разделением на компоненты представления, хранилища состояния и сервисный слой

Приложение поддерживает:
- Вложенные задачи с ограничением глубины (максимально 2 уровня)
- Закрепление задач в пользовательских слотах (pinned lists)
- Drag-and-drop для перемещения задач
- Импорт/экспорт данных в формате JSON

## 2. Структура проекта

```
src/
├── app/                    # Next.js App Router
│   ├── globals.css         # Глобальные стили (Tailwind + кастомные)
│   └── page.tsx            # Главная страница приложения
├── components/             # React-компоненты
│   ├── DropZone.tsx        # Зона для перетаскивания задач
│   ├── PinnedDropZone.tsx  # Зона для перетаскивания в закрепленные списки
│   ├── PinnedList.tsx      # Компонент закрепленного списка задач
│   ├── TodoApp.tsx         # Корневой компонент приложения
│   └── TodoItem.tsx        # Компонент отдельной задачи
├── lib/                    # Вспомогательные модули
│   ├── constants.ts        # Константы приложения (MAX_DEPTH)
│   ├── prisma.ts           # Конфигурация Prisma
│   ├── todoService.ts      # Сервисный слой для работы с задачами
│   └── types.ts            # TypeScript-типы
└── stores/                 # Управление состоянием (MobX)
    ├── TodoStore.ts        # Главное хранилище состояния
    └── TodoStoreContext.tsx # Контекст для доступа к хранилищу
```

### Описание основных директорий:

- **app/**: Содержит файлы Next.js App Router. `page.tsx` - точка входа в приложение, где происходит первоначальная загрузка состояния.
- **components/**: Переиспользуемые UI-компоненты. Каждый компонент отвечает за определенную часть интерфейса.
- **lib/**: Вспомогательные модули, содержащие бизнес-логику, типы и конфигурации.
- **stores/**: Реализация управления состоянием на стороне клиента с помощью MobX.

## 3. Ключевые модули и их взаимодействие

### Core модули:

1. **TodoStore (`stores/TodoStore.ts`)**:
   - Центральное хранилище состояния приложения
   - Управляет задачами и закрепленными списками
   - Предоставляет методы для всех операций (добавление, удаление, перемещение)
   - Реализует логику перетаскивания и валидации операций

2. **TodoService (`lib/todoService.ts`)**:
   - Сервисный слой для взаимодействия с базой данных
   - Содержит все функции для работы с Prisma
   - Обеспечивает бизнес-логику на сервере
   - Управляет транзакциями и целостностью данных

3. **Компоненты представления**:
   - **TodoApp**: Корневой компонент, инициализирует хранилище и предоставляет контекст
   - **TodoItem**: Отображает отдельную задачу с возможностью редактирования
   - **PinnedList**: Отображает закрепленный список задач
   - **DropZone**: Обрабатывает события перетаскивания

### Взаимодействие модулей:

```
UI (React компоненты)
    ↓
TodoStore (MobX)
    ↓
API маршруты Next.js (не показаны в коде)
    ↓
TodoService (Prisma)
    ↓
База данных (PostgreSQL)
```

1. Пользователь взаимодействует с UI-компонентами
2. Компоненты вызывают методы TodoStore
3. TodoStore отправляет запросы к API
4. API использует TodoService для взаимодействия с БД
5. Результат возвращается обратно по цепочке, обновляя состояние

## 4. Поток данных

### Инициализация приложения:
1. При загрузке страницы (`page.tsx`) выполняется `getTodoState()` из `todoService`
2. Данные из БД передаются в `TodoApp` как `initialState`
3. `TodoApp` создает экземпляр `TodoStore` с этим состоянием
4. Хранилище предоставляется через `TodoStoreProvider`

### Обработка действий пользователя:
1. Пользователь выполняет действие (добавление задачи, перетаскивание)
2. Компонент вызывает соответствующий метод `TodoStore`
3. `TodoStore` отправляет запрос на сервер через API
4. Сервер обрабатывает запрос через `todoService`
5. Результат (обновленное состояние) возвращается клиенту
6. `TodoStore` обновляет свое состояние, вызывая реактивное обновление UI

### Пример потока при добавлении задачи:
```
Пользователь вводит текст → 
TodoApp → 
store.addTodo(null, title) → 
fetch('/api/todos', {method: 'POST', body: JSON}) → 
API маршрут → 
todoService.addTodo() → 
Prisma создает запись в БД → 
Возвращается обновленное состояние → 
TodoStore.setState() → 
React перерисовывает компоненты
```

## 5. Руководство для разработчика

### Где искать код для X?

- **Логика задач (CRUD)**: `src/lib/todoService.ts`
- **Управление состоянием**: `src/stores/TodoStore.ts`
- **Компоненты задач**: `src/components/TodoItem.tsx`, `src/components/PinnedList.tsx`
- **Логика перетаскивания**: `src/components/DropZone.tsx`, `src/components/PinnedDropZone.tsx`
- **Импорт/экспорт данных**: Компонент `SettingsTab` в `src/components/TodoApp.tsx`
- **Стили**: `src/app/globals.css` и Tailwind классы в компонентах
- **Типы данных**: `src/lib/types.ts`

### Как добавить новую фичу Y?

Пример: Добавление приоритета для задач

1. **Обновить модель данных**:
   - Добавить поле `priority` в модель `Todo` в схеме Prisma
   - Обновить тип `TodoNode` в `src/lib/types.ts`

2. **Сервисный слой**:
   - Добавить параметр `priority` в `addTodo` и `updateTodoTitle` в `todoService.ts`
   - Реализовать логику работы с приоритетом

3. **Хранилище состояния**:
   - Добавить параметр `priority` в методы `addTodo` и `updateTitle` в `TodoStore.ts`
   - Обновить логику валидации при необходимости

4. **Компоненты**:
   - Добавить UI для выбора приоритета в `TodoItem.tsx`
   - Обновить отображение задачи с учетом приоритета

5. **API**:
   - Обновить API маршруты для обработки нового поля

### Стили и UI

- Все стили основаны на Tailwind CSS
- Глобальные стили находятся в `src/app/globals.css`
- Для специфичных стилей компонентов используются Tailwind классы напрямую в JSX
- Цветовая схема и дизайн-система определены в глобальных стилях:
  - Основной фон: `bg-canvas-light`
  - Текст: `text-slate-900`
  - Акцентные цвета: `bg-slate-900`, `bg-emerald-500`, `bg-amber-200`

### State Management

- Используется MobX с паттерном Provider/Context
- Основное хранилище: `TodoStore` в `src/stores/TodoStore.ts`
- Доступ к хранилищу через хук `useTodoStore()`
- Компоненты, которые должны реагировать на изменения состояния, оборачиваются в `observer()`
- Все изменения состояния должны происходить через методы хранилища, а не напрямую

### Работа с перетаскиванием

- Логика перетаскивания реализована в компонентах `DropZone` и `PinnedDropZone`
- Валидация возможности перетаскивания выполняется в методе `canDrop` хранилища
- Состояние перетаскивания хранится в `store.draggedId`
- Максимальная глубина вложенности определена в константе `MAX_DEPTH`

### Работа с базой данных

- Все взаимодействия с БД инкапсулированы в `todoService.ts`
- Используется Prisma ORM с PostgreSQL
- При изменении схемы данных:
  1. Обновить `schema.prisma`
  2. Создать миграцию: `npx prisma migrate dev`
  3. Сгенерировать клиент: `npx prisma generate`

### Тестирование изменений

- Убедиться, что все изменения состояния проходят через хранилище
- Проверить валидацию операций (особенно для перетаскивания)
- Протестировать работу с разными уровнями вложенности
- Проверить корректность работы закрепленных списков