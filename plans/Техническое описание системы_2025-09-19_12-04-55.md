# Техническое описание проекта: Todo-приложение с древовидной структурой задач

## 1. Обзор архитектуры

Проект представляет собой клиент-серверное приложение для управления задачами с поддержкой древовидной структуры, закрепления задач в специальных списках и системы тегов.

**Ключевые архитектурные решения:**
- **Фреймворк**: Next.js с использованием App Router
- **Управление состоянием**: MobX с реактивными компонентами через `mobx-react-lite`
- **База данных**: PostgreSQL с ORM Prisma
- **Стилизация**: Tailwind CSS с кастомными утилитами
- **Архитектура компонентов**: Функциональные компоненты с хуками и HOC `observer` для реактивности

Приложение разделено на клиентскую часть (React-компоненты и MobX-сторы) и серверную часть (API-маршруты Next.js, взаимодействующие с БД через Prisma).

## 2. Структура проекта

```
src/
├── app/                    # Корневые компоненты Next.js App Router
│   ├── globals.css        # Глобальные стили Tailwind и кастомные правила
│   └── page.tsx           # Главная страница приложения
├── components/            # React-компоненты UI
│   ├── DropZone.tsx       # Зона для сброса задач при drag-and-drop
│   ├── PinnedDropZone.tsx # Зона для сброса закрепленных задач
│   ├── PinnedList.tsx     # Компонент списка закрепленных задач
│   ├── TodoApp.tsx        # Корневой компонент приложения
│   └── TodoItem.tsx       # Компонент отдельной задачи
├── lib/                   # Вспомогательные модули и утилиты
│   ├── constants.ts       # Константы приложения (MAX_DEPTH)
│   ├── prisma.ts          # Конфигурация клиента Prisma
│   ├── todoService.ts     # Слой бизнес-логики для работы с БД
│   └── types.ts           # TypeScript-типы данных
└── stores/                # MobX-сторы для управления состоянием
    ├── TodoStore.ts       # Основной стор состояния приложения
    └── TodoStoreContext.tsx # React Context для доступа к стору
```

### Описание основных директорий:

- **`src/app/`**: Содержит корневые компоненты Next.js App Router. `page.tsx` - главная страница, которая получает начальное состояние из БД и рендерит основной компонент `TodoApp`.
- **`src/components/`**: Включает все UI-компоненты приложения:
  - `TodoApp.tsx` - корневой компонент с навигацией по вкладкам
  - `TodoItem.tsx` - компонент для отображения задачи с поддержкой вложенных задач
  - `PinnedList.tsx` - компонент для отображения закрепленных списков задач
  - `DropZone.tsx` и `PinnedDropZone.tsx` - компоненты для обработки drag-and-drop
- **`src/lib/`**: Содержит бизнес-логику и утилиты:
  - `todoService.ts` - основной модуль для работы с БД через Prisma
  - `prisma.ts` - конфигурация клиента Prisma
  - `types.ts` - определения типов данных приложения
  - `constants.ts` - константы (например, максимальная глубина вложенности задач)
- **`src/stores/`**: MobX-сторы для управления состоянием:
  - `TodoStore.ts` - основной стор, содержащий всю логику состояния приложения
  - `TodoStoreContext.tsx` - React Context для предоставления доступа к стору в компонентах

## 3. Ключевые модули и их взаимодействие

### Основные модули:

1. **TodoStore (`src/stores/TodoStore.ts`)**:
   - Центральный модуль управления состоянием приложения
   - Хранит данные о задачах, закрепленных списках, тегах, фильтрах
   - Управляет состоянием drag-and-drop, сворачивания/разворачивания элементов
   - Предоставляет методы для всех операций: добавление, редактирование, удаление задач, управление тегами и списками
   - Взаимодействует с сервером через API-эндпоинты

2. **TodoService (`src/lib/todoService.ts`)**:
   - Слой бизнес-логики для работы с базой данных
   - Содержит функции для всех CRUD-операций над задачами, списками и тегами
   - Использует Prisma для взаимодействия с PostgreSQL
   - Обеспечивает нормализацию данных и построение древовидной структуры задач

3. **Компоненты UI**:
   - `TodoApp`: Корневой компонент, управляющий вкладками и основным состоянием UI
   - `TodoItem`: Отображает задачу с поддержкой вложенных задач, тегов и действий
   - `PinnedList`: Отображает закрепленный список задач с возможностью управления
   - `DropZone`/`PinnedDropZone`: Обрабатывают drag-and-drop операции

### Взаимодействие модулей:

1. При загрузке приложения (`page.tsx`) вызывается `getTodoState()` из `todoService.ts`, который получает начальное состояние из БД.
2. Это состояние передается в `TodoApp`, который создает экземпляр `TodoStore` и помещает его в контекст.
3. Компоненты через хук `useTodoStore()` получают доступ к стору и подписываются на изменения.
4. При взаимодействии пользователя (добавление задачи, drag-and-drop и т.д.) вызываются методы стора.
5. Методы стора отправляют запросы на сервер через API, обрабатывают ответ и обновляют состояние.
6. Изменения в сторе автоматически обновляют связанные компоненты через реактивность MobX.

## 4. Поток данных

1. **Инициализация приложения**:
   ```mermaid
   graph LR
   A[page.tsx] --> B[getTodoState()]
   B --> C[Prisma/БД]
   C --> D[Начальное состояние]
   D --> E[TodoStore]
   E --> F[TodoApp]
   ```

2. **Добавление новой задачи**:
   ```mermaid
   graph LR
   A[Пользователь вводит задачу] --> B[TodoApp.onSubmit()]
   B --> C[store.addTodo()]
   C --> D[API POST /api/todos]
   D --> E[todoService.addTodo()]
   E --> F[Prisma/БД]
   F --> G[Обновленное состояние]
   G --> H[TodoStore.setState()]
   H --> I[Обновление компонентов]
   ```

3. **Drag-and-drop задачи**:
   ```mermaid
   graph LR
   A[Пользователь начинает перетаскивание] --> B[TodoItem.onDragStart()]
   B --> C[store.setDragged()]
   C --> D[Обновление UI]
   D --> E[Пользователь перетаскивает задачу]
   E --> F[DropZone.onDrop()]
   F --> G[store.moveTodo()]
   G --> H[API PATCH /api/todos/:id]
   H --> I[todoService.moveTodo()]
   I --> J[Prisma/БД]
   J --> K[Обновленное состояние]
   K --> L[TodoStore.setState()]
   L --> M[Обновление компонентов]
   ```

## 5. Руководство для разработчика

### Где искать код для X?

- **Основная логика приложения**: `src/stores/TodoStore.ts`
- **Работа с базой данных**: `src/lib/todoService.ts`
- **Отображение задачи**: `src/components/TodoItem.tsx`
- **Отображение закрепленных списков**: `src/components/PinnedList.tsx`
- **Drag-and-drop функционал**: `src/components/DropZone.tsx`, `src/components/PinnedDropZone.tsx`
- **Глобальные стили**: `src/app/globals.css`
- **Типы данных**: `src/lib/types.ts`
- **API-эндпоинты**: Не показаны в предоставленном коде, но должны находиться в `src/app/api/`

### Как добавить новый функционал Y?

**Пример: Добавление нового поля в задачу (например, "приоритет")**

1. **Обновить модель данных**:
   - В файле `prisma/schema.prisma` добавить новое поле в модель `Todo`:
     ```prisma
     model Todo {
       // ... существующие поля
       priority Priority? @default(MEDIUM)
     }
     
     enum Priority {
       LOW
       MEDIUM
       HIGH
     }
     ```
   - Выполнить миграцию: `npx prisma migrate dev`

2. **Обновить типы**:
   - В `src/lib/types.ts` обновить интерфейс `TodoNode`:
     ```typescript
     export interface TodoNode extends Todo {
       // ... существующие поля
       priority?: Priority;
     }
     ```

3. **Обновить слой работы с БД**:
   - В `src/lib/todoService.ts` обновить функции, работающие с задачами:
     ```typescript
     // В функции addTodo
     data: {
       // ... существующие поля
       priority: priority ?? 'MEDIUM',
     }
     
     // В функции updateTodoTitle (или создать новую)
     export async function updateTodoPriority(id: string, priority: Priority): Promise<TodoState> {
       // ... реализация
     }
     ```

4. **Обновить стор**:
   - В `src/stores/TodoStore.ts` добавить метод:
     ```typescript
     async updatePriority(id: string, priority: Priority) {
       await this.mutate(`/api/todos/${id}`, {
         method: 'PATCH',
         body: JSON.stringify({ action: 'updatePriority', priority }),
       });
     }
     ```

5. **Обновить компоненты**:
   - В `src/components/TodoItem.tsx` добавить отображение и редактирование приоритета:
     ```jsx
     // В интерфейсе TodoItemProps добавить priority
     // В компоненте добавить:
     <select value={todo.priority} onChange={(e) => store.updatePriority(todo.id, e.target.value)}>
       <option value="LOW">Низкий</option>
       <option value="MEDIUM">Средний</option>
       <option value="HIGH">Высокий</option>
     </select>
     ```

6. **Обновить API**:
   - Создать/обновить API-маршрут в `src/app/api/todos/[id]/route.ts` для обработки нового действия.

### Как работать со стейт-менеджментом и API?

1. **Работа с MobX**:
   - Все компоненты, использующие состояние, должны быть обернуты в HOC `observer`:
     ```javascript
     export const TodoItem = observer(TodoItemComponent)
     ```
   - Для доступа к стору используйте хук `useTodoStore()`:
     ```javascript
     const store = useTodoStore()
     ```
   - Для обновления состояния вызывайте методы стора:
     ```javascript
     await store.addTodo(parentId, title)
     ```

2. **Работа с API**:
   - Все запросы к API инкапсулированы в методах стора
   - Для отправки запросов используется метод `mutate` в сторе:
     ```javascript
     private async mutate(url: string, init: RequestInit) {
       const response = await fetch(url, {
         ...init,
         headers: { 'Content-Type': 'application/json' },
       })
       const data = await response.json()
       this.setState(data)
     }
     ```
   - API-эндпоинты должны возвращать обновленное состояние всего приложения

### Стили и UI

- **Основной подход**: Tailwind CSS с утилитарными классами
- **Глобальные стили**: `src/app/globals.css` содержит базовые настройки Tailwind и кастомные правила
- **Тематизация**: Приложение использует светлую тему с основными цветами:
  - Фон: `bg-canvas-light` (определен в globals.css)
  - Текст: `text-slate-900`
  - Акцентные цвета: `emerald` для активных элементов, `amber` для закрепленных задач
- **Компонентные стили**: Стили применяются непосредственно в компонентах через классы Tailwind
- **Адаптивность**: Используются Tailwind-классы для адаптивного дизайна (например, `sm:flex-row`, `lg:px-8`)

### State Management

- **Основной инструмент**: MobX с декораторами `makeAutoObservable`
- **Структура стора**:
  - Данные: `todos`, `pinnedLists`, `tags`
  - Состояния UI: `draggedId`, `collapsedIds`, `collapsedPinnedListIds`
  - Фильтры: `listFilterMode`, `pinnedFilterMode`
- **Реактивность**: Компоненты автоматически обновляются при изменении наблюдаемых свойств стора
- **Сохранение состояния**: Некоторые настройки (свернутые элементы, фильтры) сохраняются в `localStorage`
- **Оптимизация**: Для сложных вычислений используются геттеры (например, `visibleTodos`, `pinnedListsWithTodos`)

### Важные замечания

1. **Drag-and-drop**: Реализован через нативные HTML5 API с кастомной логикой в компонентах `DropZone` и `TodoItem`
2. **Вложенность задач**: Максимальная глубина вложенности ограничена константой `MAX_DEPTH` (5 уровней)
3. **Работа с датами**: Выполненные задачи фильтруются по дате завершения с использованием пороговых значений
4. **Теги**: Реализована система тегов с возможностью привязки к задачам
5. **Экспорт/импорт**: Данные можно экспортировать в JSON и импортировать из файла

Это описание должно помочь новым разработчикам быстро разобраться в структуре проекта и начать эффективно вносить изменения.