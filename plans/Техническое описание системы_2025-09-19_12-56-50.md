# Техническое описание проекта: Приложение для управления задачами

## 1. Обзор архитектуры

Проект представляет собой клиент-серверное приложение для управления задачами с возможностью создания вложенных структур, закрепления задач в специальных списках и управления тегами. 

Основные архитектурные решения:
- **Фреймворк**: Next.js с использованием App Router для серверного рендеринга (SSR)
- **Управление состоянием**: MobX для клиентского состояния с синхронизацией с сервером
- **База данных**: PostgreSQL с ORM Prisma
- **Стилизация**: Tailwind CSS с дополнительными глобальными стилями
- **Архитектурный паттерн**: Клиент-сервер с четким разделением между UI-компонентами, состоянием и API

Приложение имеет три основных вкладки: "Слоты" (закрепленные списки задач), "Список задач" (все задачи в виде дерева) и "Настройки" (управление тегами и импорт/экспорт данных).

## 2. Структура проекта

```
src/
├── app/                   # Директория Next.js App Router
│   ├── globals.css        # Глобальные стили (Tailwind и кастомные)
│   └── page.tsx           # Главная страница (входная точка приложения)
├── components/            # React-компоненты UI
│   ├── DropZone.tsx       # Зона для перетаскивания задач в дереве
│   ├── PinnedDropZone.tsx # Зона для перетаскивания в закрепленные списки
│   ├── PinnedList.tsx     # Компонент закрепленного списка задач
│   ├── TodoApp.tsx        # Главный компонент приложения (управление вкладками)
│   └── TodoItem.tsx       # Компонент отдельной задачи
├── lib/                   # Вспомогательные модули
│   ├── constants.ts       # Константы приложения (MAX_DEPTH)
│   ├── hooks/             # Кастомные React-хуки
│   │   └── useDropdown.ts # Хук для управления выпадающими меню
│   ├── prisma.ts          # Настройка Prisma клиента
│   ├── todoService.ts     # Сервисный слой для работы с API
│   └── types.ts           # TypeScript типы данных
└── stores/                # MobX сторы для управления состоянием
    ├── TodoStore.ts       # Основной стор приложения
    └── TodoStoreContext.tsx # Контекст для предоставления стора компонентам
```

### Описание основных директорий:

- **app/**: Содержит главную страницу приложения (`page.tsx`) и глобальные стили (`globals.css`). Здесь инициализируется приложение с получением начального состояния с сервера.
  
- **components/**: Содержит все React-компоненты пользовательского интерфейса. Каждый компонент отвечает за определенную часть UI:
  - `TodoApp.tsx` - корневой компонент, управляющий вкладками и общим состоянием
  - `TodoItem.tsx` - отображение отдельной задачи с функционалом редактирования, удаления, добавления подзадач
  - `PinnedList.tsx` - компонент для отображения закрепленных списков задач
  - `DropZone.tsx` и `PinnedDropZone.tsx` - компоненты для реализации перетаскивания задач

- **lib/**: Вспомогательные модули:
  - `todoService.ts` - сервисный слой, реализующий взаимодействие с API (CRUD-операции)
  - `types.ts` - определение всех TypeScript-типов, используемых в приложении
  - `constants.ts` - константы приложения (например, максимальная глубина вложенности задач)
  - `hooks/` - кастомные React-хуки (например, `useDropdown` для управления выпадающими меню)

- **stores/**: Содержит MobX-сторы для управления состоянием приложения:
  - `TodoStore.ts` - основной стор, содержащий всю логику управления задачами, списками, тегами и фильтрами
  - `TodoStoreContext.tsx` - React-контекст для предоставления доступа к стору в компонентах

## 3. Ключевые модули и их взаимодействие

### TodoStore (src/stores/TodoStore.ts)
Центральный модуль управления состоянием приложения:
- Хранит все задачи, закрепленные списки, теги и параметры фильтрации
- Реализует логику взаимодействия с API через сервисный слой
- Управляет состоянием UI (свернутые задачи, активные вкладки)
- Предоставляет методы для всех операций с данными (добавление, редактирование, удаление, перемещение)

### todoService (src/lib/todoService.ts)
Сервисный слой для взаимодействия с сервером:
- Реализует все CRUD-операции для задач, тегов и закрепленных списков
- Использует Prisma для работы с базой данных
- Обеспечивает синхронизацию данных между клиентом и сервером

### Компоненты UI
- **TodoApp**: Главный компонент, управляющий вкладками и общим состоянием приложения. Получает начальное состояние с сервера и инициализирует TodoStore.
- **TodoItem**: Отображает отдельную задачу, обрабатывает события редактирования, удаления, добавления подзадач, управления тегами.
- **PinnedList**: Отображает закрепленный список задач, позволяет управлять списком (переименование, удаление) и задачами внутри него.
- **DropZone/PinnedDropZone**: Компоненты для реализации перетаскивания задач между разными уровнями дерева и закрепленными списками.

### Взаимодействие модулей:
1. Пользователь взаимодействует с UI-компонентами
2. Компоненты вызывают методы TodoStore
3. TodoStore через todoService отправляет запросы на сервер
4. Сервер обрабатывает запросы и возвращает обновленные данные
5. TodoStore обновляет свое состояние
6. MobX автоматически обновляет UI-компоненты, которые зависят от измененных данных

## 4. Поток данных

1. **Инициализация приложения**:
   - При загрузке страницы `page.tsx` вызывает `getTodoState()` из `todoService.ts`
   - Сервер возвращает начальное состояние приложения (задачи, списки, теги)
   - Это состояние передается в `TodoApp`, который создает экземпляр `TodoStore`
   - `TodoStore` инициализируется полученными данными

2. **Изменение данных**:
   - Пользователь выполняет действие (например, добавляет задачу)
   - Компонент вызывает соответствующий метод `TodoStore` (например, `addTodo`)
   - `TodoStore` отправляет запрос на сервер через `todoService`
   - Сервер обновляет данные в БД и возвращает обновленное состояние
   - `TodoStore` обновляет свое состояние
   - MobX автоматически перерисовывает компоненты, зависящие от измененных данных

3. **Синхронизация состояния**:
   - После каждой операции мутации (добавление, удаление, обновление) `TodoStore` полностью обновляется данными с сервера
   - Это обеспечивает консистентность данных между клиентом и сервером
   - Некоторые состояния UI (свернутые задачи, фильтры) сохраняются в `localStorage` для сохранения между сессиями

## 5. Руководство для разработчика

### Где искать код для определенного функционала?

- **Управление задачами (CRUD)**: `src/stores/TodoStore.ts` (методы `addTodo`, `updateTitle`, `deleteTodo` и др.) и `src/lib/todoService.ts` (соответствующие серверные функции)
- **Работа с закрепленными списками**: `src/components/PinnedList.tsx` (UI) и `src/stores/TodoStore.ts` (методы `addPinnedList`, `renamePinnedList`, `deletePinnedList`)
- **Управление тегами**: `src/components/TodoApp.tsx` (вкладка "Настройки") и `src/stores/TodoStore.ts` (методы `addTag`, `renameTag`, `deleteTag`, `attachTag`, `detachTag`)
- **Перетаскивание задач**: `src/components/DropZone.tsx`, `src/components/PinnedDropZone.tsx` и `src/components/TodoItem.tsx` (обработчики событий drag-and-drop)
- **Фильтрация задач**: `src/stores/TodoStore.ts` (свойства `listFilterMode`, `pinnedFilterMode` и метод `filterTree`)
- **Импорт/экспорт данных**: `src/components/TodoApp.tsx` (компонент `SettingsTab`)

### Как добавить новую функциональность?

Пример: Добавление нового атрибута для задач (например, приоритет)

1. **Обновление типов данных**:
   - В `src/lib/types.ts` добавить новое поле в интерфейс `TodoNode`:
     ```typescript
     export interface TodoNode extends Todo {
       children: TodoNode[];
       tags?: Tag[];
       priority?: 'low' | 'medium' | 'high'; // Новое поле
     }
     ```

2. **Обновление бэкенда**:
   - Создать миграцию Prisma для добавления нового поля в модель `Todo`
   - В `src/lib/todoService.ts` обновить функции, работающие с задачами:
     - `addTodo` - добавить обработку нового поля
     - `updateTodoTitle` - переименовать в `updateTodo` и добавить обновление приоритета
     - `getTodoState` - убедиться, что поле включается в выборку

3. **Обновление стора**:
   - В `src/stores/TodoStore.ts` добавить метод для обновления приоритета:
     ```typescript
     async updatePriority(id: string, priority: 'low' | 'medium' | 'high') {
       await this.mutate(`/api/todos/${id}`, {
         method: 'PATCH',
         body: JSON.stringify({ action: 'updatePriority', priority }),
       });
     }
     ```

4. **Обновление UI**:
   - В `src/components/TodoItem.tsx` добавить элементы управления для приоритета:
     - В режиме просмотра отображать индикатор приоритета
     - В режиме редактирования добавить выбор приоритета
     - Вызывать новый метод стора при изменении приоритета

5. **Тестирование**:
   - Проверить корректность сохранения и отображения приоритета
   - Убедиться, что приоритет корректно обрабатывается при импорте/экспорте данных

### Как работать со стилями?

- **Основной механизм стилизации**: Tailwind CSS
- **Глобальные стили**: `src/app/globals.css`
  - Здесь определены базовые стили, переменные и настройки Tailwind
  - Добавлены кастомные классы для элементов интерфейса (кнопки, body)
- **Компонентные стили**: Используются утилитарные классы Tailwind непосредственно в компонентах
- **Тематизация**: Приложение использует только светлую тему (`color-scheme: only light` в globals.css)
- **Кастомизация**: Для добавления новых стилей:
  1. Проверить, нет ли подходящего класса в Tailwind
  2. При необходимости добавить кастомные классы в `globals.css` с использованием `@apply`
  3. Для сложных компонентов можно использовать CSS-модули или styled-components (но в текущем проекте не используется)

### Как работать с управлением состояния (State Management)?

- **Основной инструмент**: MobX
- **Доступ к стору**: Через хук `useTodoStore` из `src/stores/TodoStoreContext.tsx`
  ```typescript
  const store = useTodoStore();
  ```
- **Обновление состояния**: Все изменения должны происходить через методы стора, а не прямую мутацию:
  ```typescript
  // Неправильно
  store.todos.push(newTodo);
  
  // Правильно
  await store.addTodo(parentId, title);
  ```
- **Реактивность**: Компоненты, которые зависят от состояния стора, должны быть обернуты в `observer` из `mobx-react-lite`:
  ```typescript
  export const TodoItem = observer(TodoItemComponent);
  ```
- **Сохранение состояния между сессиями**: Некоторые состояния (свернутые задачи, фильтры) автоматически сохраняются в `localStorage` и восстанавливаются при загрузке приложения.
- **Синхронизация с сервером**: После каждой операции мутации стор обновляется данными с сервера, что гарантирует консистентность.

### Дополнительные рекомендации

1. **Добавление новых API endpoints**:
   - Создать соответствующие функции в `src/lib/todoService.ts`
   - Добавить методы для вызова этих API в `TodoStore`
   - Обновить типы в `src/lib/types.ts` при необходимости

2. **Работа с перетаскиванием**:
   - Логика перетаскивания реализована с использованием HTML5 Drag and Drop API
   - При добавлении новых зон для перетаскивания использовать существующие компоненты `DropZone` и `PinnedDropZone` как пример

3. **Тестирование**:
   - Все изменения состояния должны тестироваться на корректность сохранения и отображения
   - Особое внимание уделять операциям с вложенными структурами и перемещению элементов

4. **Производительность**:
   - При работе с большими деревьями задач следить за оптимизацией рендеринга
   - Использовать `memo` и `observer` для предотвращения ненужных перерисовок компонентов