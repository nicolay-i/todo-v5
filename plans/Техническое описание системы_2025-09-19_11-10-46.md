# Техническое описание проекта: Todo-приложение с закрепленными списками

## 1. Обзор архитектуры

**Архитектурный паттерн:** Клиент-серверное приложение с монолитной структурой.

- **Фронтенд:** React-приложение на Next.js 14 с использованием App Router, TypeScript и MobX для управления состоянием.
- **Бэкенд:** API-маршруты Next.js с Prisma ORM в качестве слоя доступа к данным.
- **База данных:** PostgreSQL (предполагается на основе использования Prisma).
- **Стилизация:** Tailwind CSS с дополнительными глобальными стилями.

**Ключевые архитектурные решения:**
- **State Management:** MobX используется для управления состоянием приложения. Хранилище инкапсулирует всю бизнес-логику и взаимодействие с API.
- **Компоненты:** Применяется паттерн "наблюдатель" (observer) для реактивного обновления UI при изменении состояния.
- **Drag-and-Drop:** Реализована нативная поддержка HTML5 Drag and Drop API для перемещения задач между списками и изменения иерархии.
- **Структура данных:** Задачи организованы в виде древовидной структуры с ограниченной глубиной вложенности (MAX_DEPTH = 5). Закрепленные задачи могут принадлежать специальным спискам (слотам).

## 2. Структура проекта

```
src/
├── app/                    # Директория Next.js App Router
│   ├── api/               # API-маршруты (не показаны в коде)
│   ├── globals.css        # Глобальные стили (Tailwind и кастомные)
│   └── page.tsx           # Главная страница приложения
├── components/            # React-компоненты
│   ├── DropZone.tsx       # Зона для сброса задач при перемещении
│   ├── PinnedDropZone.tsx # Зона для сброса в закрепленных списках
│   ├── PinnedList.tsx     # Компонент закрепленного списка задач
│   ├── TodoApp.tsx        # Корневой компонент приложения
│   └── TodoItem.tsx       # Компонент отдельной задачи
├── lib/                   # Вспомогательные модули
│   ├── constants.ts       # Константы (например, MAX_DEPTH)
│   ├── prisma.ts          # Настройка Prisma Client
│   ├── todoService.ts     # Сервисный слой для работы с API
│   └── types.ts           # TypeScript-типы
└── stores/                # Хранилища состояния (MobX)
    ├── TodoStore.ts       # Основное хранилище состояния
    └── TodoStoreContext.tsx # Контекст для предоставления хранилища
```

**Описание основных директорий:**

- **`src/app/`** - содержит файлы маршрутизации Next.js:
  - `page.tsx` - главная страница, инициализирующая приложение с начальным состоянием
  - `globals.css` - глобальные стили, включая настройки Tailwind и базовые стили для body и кнопок

- **`src/components/`** - содержит все React-компоненты UI:
  - `TodoApp.tsx` - корневой компонент, управляющий вкладками (слоты, список задач, настройки)
  - `TodoItem.tsx` - компонент для отображения задачи с поддержкой вложенности
  - `PinnedList.tsx` - компонент для отображения закрепленного списка задач
  - `DropZone.tsx` и `PinnedDropZone.tsx` - компоненты для реализации drag-and-drop

- **`src/lib/`** - вспомогательные модули:
  - `todoService.ts` - содержит функции для взаимодействия с API (CRUD операции)
  - `types.ts` - определение TypeScript-типов для сущностей приложения
  - `prisma.ts` - настройка Prisma Client для работы с базой данных
  - `constants.ts` - константы приложения (максимальная глубина вложенности)

- **`src/stores/`** - хранилища состояния на основе MobX:
  - `TodoStore.ts` - основное хранилище, содержащее всю логику управления состоянием
  - `TodoStoreContext.tsx` - React Context для предоставления хранилища компонентам

## 3. Ключевые модули и их взаимодействие

### Основные модули:

1. **TodoStore (`stores/TodoStore.ts`)**
   - Центральное хранилище состояния приложения на MobX
   - Содержит массивы задач (`todos`), закрепленных списков (`pinnedLists`), тегов (`tags`)
   - Управляет состоянием перетаскивания (`draggedId`) и свернутых узлов (`collapsedIds`)
   - Предоставляет методы для изменения состояния (добавление, удаление, перемещение задач)
   - Взаимодействует с API через HTTP-запросы

2. **TodoService (`lib/todoService.ts`)**
   - Сервисный слой, инкапсулирующий логику взаимодействия с API
   - Содержит функции для выполнения CRUD операций с задачами, списками и тегами
   - Обеспечивает валидацию данных и обработку ошибок

3. **Компоненты (`components/`)**
   - `TodoApp` - корневой компонент, инициализирующий хранилище и управляющий вкладками
   - `TodoItem` - компонент для отображения задачи с поддержкой вложенности
   - `PinnedList` - компонент для отображения закрепленного списка задач
   - `DropZone` и `PinnedDropZone` - компоненты для реализации drag-and-drop

### Взаимодействие модулей:

1. **Инициализация приложения:**
   - На сервере (`page.tsx`) вызывается `getTodoState()` из `todoService.ts`
   - Полученное начальное состояние передается в `TodoApp`
   - В `TodoApp` создается экземпляр `TodoStore` с этим состоянием
   - Хранилище предоставляется компонентам через `TodoStoreProvider`

2. **Обработка пользовательских действий:**
   - Пользователь взаимодействует с компонентом (например, перетаскивает задачу)
   - Компонент вызывает соответствующий метод хранилища (например, `store.moveTodo`)
   - Метод хранилища отправляет HTTP-запрос к API через `todoService`
   - После получения ответа хранилище обновляет свое состояние
   - Компоненты, наблюдаемые за изменениями, автоматически обновляются

## 4. Поток данных

1. **Инициализация:**
   ```mermaid
   graph LR
   A[База данных] -->|getTodoState| B[todoService]
   B -->|Начальное состояние| C[page.tsx]
   C -->|Пропс initialState| D[TodoApp]
   D -->|Создание хранилища| E[TodoStore]
   E -->|Предоставление через Context| F[Компоненты]
   ```

2. **Обработка действий:**
   ```mermaid
   graph LR
   A[Пользователь] -->|Действие| B[Компонент]
   B -->|Вызов метода| C[TodoStore]
   C -->|HTTP запрос| D[todoService]
   D -->|API запрос| E[Сервер/БД]
   E -->|Ответ| D
   D -->|Обновленное состояние| C
   C -->|Обновление состояния| F[Компоненты-наблюдатели]
   F -->|Перерисовка| G[UI]
   ```

3. **Реактивность:**
   - Все компоненты, использующие данные из хранилища, обернуты в `observer`
   - При изменении состояния в хранилище эти компоненты автоматически перерисовываются
   - Для управления локальным состоянием компонентов (например, режим редактирования) используется `useState`

## 5. Руководство для разработчика

### Где искать код для X?

- **Логика работы с задачами (CRUD):**
  - Основные методы: `stores/TodoStore.ts` (`addTodo`, `updateTitle`, `toggleTodo`, `deleteTodo`)
  - Сервисный слой: `lib/todoService.ts` (функции с теми же именами)
  - API-эндпоинты: `app/api/todos/` (не показаны, но подразумеваются)

- **Логика работы с закрепленными списками:**
  - Методы хранилища: `stores/TodoStore.ts` (`addPinnedList`, `renamePinnedList`, `deletePinnedList`)
  - Сервисные функции: `lib/todoService.ts` (функции `addPinnedList`, `renamePinnedList`, `deletePinnedList`)
  - Компонент: `components/PinnedList.tsx`

- **Drag-and-Drop:**
  - Логика перетаскивания: `components/TodoItem.tsx` (обработчики drag-событий)
  - Зоны для сброса: `components/DropZone.tsx` и `components/PinnedDropZone.tsx`
  - Управление состоянием: `stores/TodoStore.ts` (методы `setDragged`, `clearDragged`, `moveTodo`)

- **Работа с тегами:**
  - Методы хранилища: `stores/TodoStore.ts` (`addTag`, `renameTag`, `deleteTag`, `attachTag`, `detachTag`)
  - Сервисные функции: `lib/todoService.ts` (функции `addTag`, `renameTag`, `deleteTag`, `attachTagToTodo`, `detachTagFromTodo`)
  - Отображение: `components/TodoItem.tsx` (блок с тегами)

- **Стили:**
  - Глобальные стили: `src/app/globals.css`
  - Компонентные стили: классы Tailwind, заданные непосредственно в JSX каждого компонента

### Как добавить новую фичу Y?

**Пример: Добавление нового поля для задачи (например, приоритет)**

1. **Изменение базы данных:**
   - Добавить поле `priority` в модель `Todo` в `schema.prisma`
   - Создать и применить миграцию: `npx prisma migrate dev --name add-priority`

2. **Обновление типов:**
   - В `lib/types.ts` добавить поле `priority` в интерфейс `TodoNode`

3. **Серверная часть:**
   - Обновить функции в `lib/todoService.ts` для работы с новым полем:
     - Добавить обработку `priority` в `normalizeTodos`
     - Обновить функции создания/обновления задач
   - Обновить API-эндпоинты для обработки нового поля

4. **Хранилище состояния:**
   - В `stores/TodoStore.ts` добавить методы для обновления приоритета
   - Обновить метод `setState` для обработки нового поля

5. **Компоненты:**
   - В `components/TodoItem.tsx` добавить UI для отображения и изменения приоритета
   - Добавить обработчики событий для вызова методов хранилища

6. **Тестирование:**
   - Проверить корректность сохранения, отображения и обновления нового поля

### Как работать со стейт-менеджментом и API?

- **State Management (MobX):**
  - Все состояние приложения хранится в `TodoStore`
  - Компоненты получают доступ к хранилищу через хук `useTodoStore()`
  - Для реактивности компоненты должны быть обернуты в `observer`
  - Изменение состояния должно происходить только через методы хранилища

- **Работа с API:**
  - Все взаимодействия с сервером инкапсулированы в методах хранилища
  - Методы хранилища отправляют запросы и обновляют состояние на основе ответа
  - При ошибке запроса хранилище пытается восстановить состояние через `refresh()`
  - Для добавления нового API-эндпоинта:
    1. Создать файл маршрута в `app/api/`
    2. Реализовать обработчик с вызовом функции из `todoService`
    3. Добавить метод в хранилище для отправки запроса

**Пример добавления нового метода:**

```typescript
// В stores/TodoStore.ts
async setPriority(id: string, priority: number) {
  await this.mutate(`/api/todos/${id}/priority`, {
    method: 'PATCH',
    body: JSON.stringify({ priority }),
  });
}

// В lib/todoService.ts
export async function setTodoPriority(id: string, priority: number): Promise<TodoState> {
  await prisma.todo.update({
    where: { id },
    data: { priority },
  });
  return getTodoState();
}

// В components/TodoItem.tsx
const handlePriorityChange = (newPriority: number) => {
  store.setPriority(todo.id, newPriority);
};
```